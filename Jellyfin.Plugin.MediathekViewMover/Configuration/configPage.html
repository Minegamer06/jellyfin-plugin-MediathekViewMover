<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Template</title>
    <style>
        .moverTaskItem {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .moverTaskItem label {
            flex: 1 1 100%;
            margin-bottom: 5px;
        }

        .moverTaskItem input {
            flex: 1 1 calc(25% - 10px);
        }

        .removeMoverTask {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        .removeMoverTask:hover {
            background-color: #ff1a1a;
        }

        .folderDialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1000;
        }

        .folderDialog input {
            width: 100%;
            margin-bottom: 10px;
        }

        .folderDialog button {
            margin-right: 10px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="TemplateConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="TemplateConfigForm">
                    <div class="selectContainer">
                        <label class="selectLabel" for="Options">Several Options</label>
                        <select is="emby-select" id="Options" name="Options" class="emby-select-withcolor emby-select">
                            <option id="optOneOption" value="OneOption">One Option</option>
                            <option id="optAnotherOption" value="AnotherOption">Another Option</option>
                        </select>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="AnInteger">An Integer</label>
                        <input id="AnInteger" name="AnInteger" type="number" is="emby-input" min="0" />
                        <div class="fieldDescription">A Description</div>
                    </div>
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="TrueFalseSetting" name="TrueFalseCheckBox" type="checkbox" is="emby-checkbox" />
                            <span>A Checkbox</span>
                        </label>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="AString">A String</label>
                        <input id="AString" name="AString" type="text" is="emby-input" />
                        <div class="fieldDescription">Another Description</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel">Folder Mappings</label>
                        <div id="MoverTasksList"></div>
                        <button type="button" is="emby-button" class="raised emby-button" id="AddMoverTaskBtn">
                            <span>Mapping hinzufügen</span>
                        </button>
                        <div class="fieldDescription">Definiere hier die Ordner-Zuordnungen für den Mover.</div>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="overlay" id="folderDialogOverlay"></div>
        <div class="folderDialog" id="folderDialog">
            <label for="folderPathInput">Select Folder Path:</label>
            <input type="text" id="folderPathInput" placeholder="Enter folder path or browse...">
            <button id="folderDialogConfirm">Confirm</button>
            <button id="folderDialogCancel">Cancel</button>
        </div>
        <script type="text/javascript">
            var TemplateConfig = {
                pluginUniqueId: '18C3F73B-DC8F-4170-A8D0-04EC1A65AD6A'
            };

            function renderMoverTasks(mappings) {
                var list = document.getElementById('MoverTasksList');
                list.innerHTML = '';
                mappings.forEach(function(mapping, idx) {
                    var div = document.createElement('div');
                    div.className = 'moverTaskItem';
                    div.innerHTML =
                        '<label for="moverTaskTitle' + idx + '">Title</label>'
                        + '<input id="moverTaskTitle' + idx + '" type="text" placeholder="Title" class="moverTaskTitle emby-input" value="' + (mapping.Title || '') + '" /> '
                        + '<label for="moverTaskMinCount' + idx + '">MinCount</label>'
                        + '<input id="moverTaskMinCount' + idx + '" type="number" min="0" placeholder="MinCount" class="moverTaskMinCount emby-input" value="' + (mapping.MinCount || 0) + '" /> '
                        + '<label for="MoverTasksource' + idx + '">Source Folder</label>'
                        + '<input id="MoverTasksource' + idx + '" type="text" placeholder="Source Folder" class="MoverTasksource emby-input" value="' + (mapping.SourceShowFolder || '') + '" /> '
                        + '<button type="button" class="selectFolder emby-button" onclick="openFolderDialog(' + idx + ', \'Source\')">Select</button>'
                        + '<label for="moverTaskTarget' + idx + '">Target Folder</label>'
                        + '<input id="moverTaskTarget' + idx + '" type="text" placeholder="Target Folder" class="moverTaskTarget emby-input" value="' + (mapping.TargetShowFolder || '') + '" /> '
                        + '<button type="button" class="selectFolder emby-button" onclick="openFolderDialog(' + idx + ', \'Target\')">Select</button>'
                        + '<button type="button" class="removeMoverTask emby-button">Entfernen</button>';
                    // Remove-Button Event
                    div.querySelector('.removeMoverTask').onclick = function() {
                        mappings.splice(idx, 1);
                        renderMoverTasks(mappings);
                    };
                    // Change-Events
                    div.querySelector('.moverTaskTitle').oninput = function(e) { mapping.Title = e.target.value; };
                    div.querySelector('.moverTaskMinCount').oninput = function(e) { mapping.MinCount = parseInt(e.target.value) || 0; };
                    div.querySelector('.MoverTasksource').oninput = function(e) { mapping.SourceShowFolder = e.target.value; };
                    div.querySelector('.moverTaskTarget').oninput = function(e) { mapping.TargetShowFolder = e.target.value; };
                    list.appendChild(div);
                });
            }

            var currentMoverTasks = [];

            document.querySelector('#TemplateConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function (config) {
                        document.querySelector('#Options').value = config.Options;
                        document.querySelector('#AnInteger').value = config.AnInteger;
                        document.querySelector('#TrueFalseSetting').checked = config.TrueFalseSetting;
                        document.querySelector('#AString').value = config.AString;
                        currentMoverTasks = config.MoverTasks || [];
                        renderMoverTasks(currentMoverTasks);
                        Dashboard.hideLoadingMsg();
                    });
                });

            document.getElementById('AddMoverTaskBtn').onclick = function() {
                currentMoverTasks.push({ Title: '', MinCount: 0, SourceShowFolder: '', TargetShowFolder: '' });
                renderMoverTasks(currentMoverTasks);
            };

            document.querySelector('#TemplateConfigForm')
                .addEventListener('submit', function(e) {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function (config) {
                        config.Options = document.querySelector('#Options').value;
                        config.AnInteger = document.querySelector('#AnInteger').value;
                        config.TrueFalseSetting = document.querySelector('#TrueFalseSetting').checked;
                        config.AString = document.querySelector('#AString').value;
                        config.MoverTasks = currentMoverTasks;
                        ApiClient.updatePluginConfiguration(TemplateConfig.pluginUniqueId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });

                    e.preventDefault();
                    return false;
                });

            function openFolderDialog(index, type) {
                const picker = new Dashboard.DirectoryBrowser();
                picker.show({
                    header: type === "Source" ? "Select Source Folder" : "Select Target Folder",
                    includeDirectories: true,
                    includeFiles: false,
                    callback: function (path) {
                        if (path) {
                            if (type === "Source") {
                                currentMoverTasks[index].SourceShowFolder = path;
                                document.getElementById('MoverTasksource' + index).value = path;
                            } else if (type === "Target") {
                                currentMoverTasks[index].TargetShowFolder = path;
                                document.getElementById('moverTaskTarget' + index).value = path;
                            }
                        }

                        picker.close();
                    }
                });
            }
        </script>
    </div>
</body>
</html>
